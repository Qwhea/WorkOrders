def print_receipt_html(state):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML-—á–µ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –ø–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ Chrome —Å —Ñ–ª–∞–≥–æ–º --kiosk-printing.
    –¢—Ä–µ–±—É–µ—Ç: Chrome —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω + –≤–∞—à –ø—Ä–∏–Ω—Ç–µ—Ä 80C —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –ø—Ä–∏–Ω—Ç–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
    """
    import webbrowser
    import os
    import tempfile
    from datetime import datetime

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
    MAX_WIDTH = "58mm"
    FONT_SIZE = "15px"
    LINE_HEIGHT = "1.2"

    delivery_cost = state.get("delivery_price", 0)
    total = calculate_total(state["items"], delivery_price=delivery_cost)

    html = f"""
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <title>–ß–µ–∫</title>
        <style>
            @page {{
                size: {MAX_WIDTH} auto;
                margin: 2mm;
            }}
            body {{
                width: {MAX_WIDTH};
                font-family: 'sistem_ui';
                font-size: {FONT_SIZE};
                font-weight: 700;           /* –ü–æ–ª—É–∂–∏—Ä–Ω—ã–π, –Ω–æ –Ω–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π */
                line-height: {LINE_HEIGHT};
                margin: 0;
                padding: 4px;
                box-sizing: border-box;
            }}

            .center {{ text-align: center; }}
            .right {{ float: right; }}
            .hr {{ border-top: 1px dashed #000; margin: 4px 0; clear: both; }}
            .item {{ margin: 2px 0; }}
            .comment {{ margin-left: 10px; color: #555; font-size: 9px; }}
            .total {{ font-weight: bold; font-size: 11px; margin-top: 6px; }}
            .header {{ font-size: 12px; margin-bottom: 4px; }}
        </style>
        <script>
            // –ê–≤—Ç–æ–ø–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ 300 –º—Å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            window.addEventListener('load', () => {{
                setTimeout(() => {{
                    window.print();
                }}, 300);
            }});
        </script>
    </head>
    <body>
        <div class="center header"><b>–û—Ä—Ö–∏–¥–µ—è</b></div>
        <div class="hr"></div>
    """

    order_num = len(load_orders()) + 1
    now = datetime.now().strftime("%d.%m %H:%M")
    html += f"""
        <div>–ó–∞–∫–∞–∑ ‚Ññ{order_num:06d}</div>
        <div>–í—Ä–µ–º—è: {now}</div>
        <div class="hr"></div>
    """

    if state.get("phone"):   html += f"<div>–¢–µ–ª: {state['phone']}</div>"
    if state.get("address"): html += f"<div>–ê–¥—Ä: {cut_text(state['address'], 32)}</div>"
    if state.get("time"):    html += f"<div>–í—Ä–µ–º—è: {state['time']}</div>"
    if state.get("delivery_date"): html += f"<div>–î–∞—Ç–∞: {state['delivery_date']}</div>"
    if state.get("delivery_zone"):
        html += f"<div>–†–∞–π–æ–Ω: {state['delivery_zone'].capitalize()}</div>"
        html += f"<div>–î–æ—Å—Ç–∞–≤–∫–∞: <span class='right'>{delivery_cost:,} ‚ÇΩ</span></div>".replace(",", " ")

    html += "<div class='hr'></div>"

    for idx, item in enumerate(state["items"], start=1):
        name = item["name"]
        qty = item["qty"]
        comment = item["comment"]
        price_per_unit = item.get("source_price") or next((i["price"] for i in MENU_ITEMS if i["name"] == item["name"]), 0)
        line_total = price_per_unit * qty

        html += f"""
        <div class="item">
            <div>{idx}. {name}</div>
            <div>–ö–æ–ª-–≤–æ: {qty} —à—Ç. <span class='right'>{line_total:,} ‚ÇΩ</span></div>
        </div>
        """.replace(",", "")

        if comment:
            html += f"<div class='comment'>‚ö†Ô∏è {comment.capitalize()}</div>"
        if idx < len(state["items"]):
            html += "<div class='hr'></div>"

    html += "<div class='hr'></div>"
    html += f"<div class='total'>–ò–¢–û–ì–û: <span class='right'>{total:,} ‚ÇΩ</span></div>".replace(",", "")
    html += "<div class='hr'></div>"
    html += "<div class='center'>–°–ø–∞—Å–∏–±–æ!</div>"
    html += "</body></html>"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π HTML
    temp_dir = tempfile.gettempdir()
    html_path = os.path.join(temp_dir, f"receipt_{int(datetime.now().timestamp())}.html")
    with open(html_path, "w", encoding="utf-8") as f:
        f.write(html)

    logging.info(f"üìÑ –í—Ä–µ–º–µ–Ω–Ω—ã–π HTML —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {html_path}")

    # –§–æ—Ä–º–∏—Ä—É–µ–º URL
    file_url = f"file://{html_path}"

    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ Chrome ‚Üí –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω --kiosk-printing ‚Üí –Ω–∞–ø–µ—á–∞—Ç–∞–µ—Ç –±–µ–∑ –¥–∏–∞–ª–æ–≥–∞
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Chrome —è–≤–Ω–æ
        chrome_path = find_chrome_path()
        if chrome_path:
            import subprocess
            subprocess.Popen([
                chrome_path,
                "--new-window",
                "--kiosk-printing",
                "--disable-popup-blocking",
                "--headless",
                file_url
            ])
            logging.info(f"üñ®Ô∏è Chrome –∑–∞–ø—É—â–µ–Ω –¥–ª—è –ø–µ—á–∞—Ç–∏: {file_url}")
        else:
            webbrowser.open(file_url)
            logging.warning("‚ö†Ô∏è Chrome –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—Ä–∞—É–∑–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Chrome: {e}")
        webbrowser.open(file_url)







            find_chrome_path()

                        check_files()
                           await show_zone_selection(message, matches, order_id)
find_delivery_zone_by_address(address_guess)



def find_chrome_path():
    """–ù–∞—Ö–æ–¥–∏—Ç –ø—É—Ç—å –∫ Chrome."""
    paths = [
        r"C:\Program Files\Google\Chrome\Application\chrome.exe"
    ]
    for path in paths:
        if os.path.exists(path):
            return path
    return None

def check_files():
    if not os.path.exists(ACTIVE_ORDERS_JSON):
        with open(ACTIVE_ORDERS_JSON, "w", encoding="utf-8") as f:
            json.dump([], f, ensure_ascii=False, indent=4)
        logging.info(f"‚úÖ –°–æ–∑–¥–∞–Ω –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª: {ACTIVE_ORDERS_JSON}")

    if not os.path.exists(FUTURE_ORDERS_JSON):
        with open(FUTURE_ORDERS_JSON, "w", encoding="utf-8") as f:
            json.dump([], f, ensure_ascii=False, indent=4)
        logging.info(f"‚úÖ –°–æ–∑–¥–∞–Ω –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª: {FUTURE_ORDERS_JSON}")



def find_delivery_zone_by_address(address):
    if not address or len(address.strip()) < 2:
        return []

    try:
        df = pd.read_excel(ADDRESS_XLSX)
        street_col = next((col for col in df.columns if "street" in col.lower()), "street")
        zone_col = next((col for col in df.columns if "zone" in col.lower() or "—Ä–∞–π–æ–Ω" in col.lower()), "zone")
        price_col = next((col for col in df.columns if "price" in col.lower() or "—Ü–µ–Ω–∞" in col.lower()), "price")

        input_clean = clean_street_name(address)
        if not input_clean:
            return []

        matches = []
        for _, row in df.iterrows():
            street_db = str(row[street_col])
            db_clean = clean_street_name(street_db)
            zone = str(row[zone_col]).strip()
            price = int(row[price_col]) if pd.notna(row[price_col]) else 0

            if input_clean == db_clean:
                matches.append((zone, price, street_db))

        logging.info(f"üîç –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É: '{address}' ‚Üí clean='{input_clean}'")
        logging.info(f"   –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(matches)}")
        for zone, price, street_db in matches:
            logging.info(f"   ‚Üí –ó–æ–Ω–∞: {zone}, –¶–µ–Ω–∞: {price} ‚ÇΩ, –£–ª–∏—Ü–∞ –ë–î: {street_db}")

        return matches

    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∑–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏: {e}")
        return []

async def show_zone_selection(message, matches, order_id):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∑–æ–Ω—ã."""
    keyboard = []
    for i, (zone, price, street_db) in enumerate(matches):
        keyboard.append([InlineKeyboardButton(f"{zone} ‚Äî {price} ‚ÇΩ ({street_db})", callback_data=f"select_zone_{i}")])

    reply_markup = InlineKeyboardMarkup(keyboard)
    msg = await message.reply_text("üìç –ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é:", reply_markup=reply_markup)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤—ã–±–æ—Ä–æ–º –∑–æ–Ω—ã
    user_id = message.from_user.id
    ORDER_STATE[order_id]["zone_selection_message_id"] = msg.id
    logging.info(f"üìå –°–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –∑–æ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {msg.id}")


def cut_text(text, max_len):
    """–û–±—Ä–µ–∑–∞–µ—Ç —Ç–µ–∫—Å—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã."""
    if len(text) <= max_len:
        return text
    return text[:max_len - 1] + "‚Ä¶"


@bot_app.on_callback_query()
async def handle_callback(client, callback):
    user_id = callback.from_user.id
    data = callback.data

    logging.info(f"üîî Callback –æ—Ç {user_id}: {data}")
    if user_id not in USER_EDIT_STATE:
        logging.warning(f"‚ö†Ô∏è –ù–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    else:
        logging.info(f"üí¨ –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ: {list(USER_EDIT_STATE[user_id].keys())}")

    if data == "admin_active_orders":
        active_orders = load_active_orders()
        if not active_orders:
            await callback.answer("üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤")
            return

        keyboard = []
        for order in active_orders:
            order_id = order.get("id", "–±/–Ω")
            addr = (order.get("address") or "–°–∞–º–æ–≤—ã–≤–æ–∑").strip()
            phone = order.get("phone") or "‚Äî"
            total = order.get("total", 0)

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ
            if phone != "‚Äî" and phone is not None:
                phone_last_4 = phone[-4:]
            else:
                phone_last_4 = "‚Äî"

            btn_text = f"{addr.capitalize()}... | {phone_last_4} | {total}‚ÇΩ"
            keyboard.append([
                InlineKeyboardButton(
                    btn_text,
                    callback_data=f"view_active_order_{order_id}"
                )
            ])

        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")])

        await callback.message.edit_text(
            "<b>üì¶ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        await callback.answer()


    elif data == "admin_future_orders":
        future_orders = load_future_orders()
        if not future_orders:
            await callback.answer("üì≠ –ù–µ—Ç –±—É–¥—É—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤")
            return

        keyboard = []
        for order in future_orders:
            order_id = order.get("id", "–±/–Ω")
            addr = (order.get("address") or "–°–∞–º–æ–≤—ã–≤–æ–∑")[:15].strip()
            phone = order.get("phone") or "‚Äî"
            date_str = order.get("delivery_date", "‚Äî")
            total = order.get("total", 0)

            phone_last_4 = phone[-4:] if phone and phone != "‚Äî" else "‚Äî"

            btn_text = f"üìÖ {date_str} | {addr}... | {phone_last_4} | {total}‚ÇΩ"
            keyboard.append([
                InlineKeyboardButton(
                    btn_text,
                    callback_data=f"view_future_order_{order_id}"
                )
            ])

        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")])

        await callback.message.edit_text(
            "<b>üìÖ –ó–∞–∫–∞–∑—ã –≤ –±—É–¥—É—â–µ–º</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        await callback.answer()

    elif data == "admin_salary":
        # –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á—ë—Ç: —Å—É–º–º–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö + –±—É–¥—É—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
        active_orders = load_active_orders()
        future_orders = load_future_orders()

        # –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì
        today_str = datetime.now().strftime("%d.%m.%Y")

        # –§–∏–ª—å—Ç—Ä—É–µ–º –±—É–¥—É—â–∏–µ –∑–∞–∫–∞–∑—ã ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        today_future_orders = [o for o in future_orders if o.get("delivery_date") == today_str]

        total_active = sum(o["total"] for o in active_orders)
        total_today_future = sum(o["total"] for o in today_future_orders)
        total_all = total_active + total_today_future

        # –î–æ—Ö–æ–¥ –æ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –∏ –±—É–¥—É—â–∏–º –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        delivery_income = (
                sum(o.get("delivery_price", 0) for o in active_orders) +
                sum(o.get("delivery_price", 0) for o in today_future_orders)
        )

        # –í—ã—Ä—É—á–∫–∞ –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤ (–±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏)
        food_income = total_all - delivery_income
        count_all = len(active_orders) + len(today_future_orders)

        avg_check = food_income // count_all if count_all else 0

        text = textwrap.dedent(f"""
            <b>üí∞ –†–∞—Å—á—ë—Ç –≤—ã—Ä—É—á–∫–∏ (–∑–∞—Ä–ø–ª–∞—Ç–∞)</b>

            üì¶ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã: <b>{total_active:,} ‚ÇΩ</b>
            üìÖ –ë—É–¥—É—â–∏–µ –∑–∞–∫–∞–∑—ã: <b>{total_today_future:,} ‚ÇΩ</b>

            üç£ <b>–í—ã—Ä—É—á–∫–∞:</b> <code>{food_income:,} ‚ÇΩ</code>
            üöö <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> <code>{delivery_income:,} ‚ÇΩ</code>

            üìä –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (–±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏): <b>{avg_check:,} ‚ÇΩ</b>
            üìå –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: <b>{count_all}</b>

            üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞: <b>{food_income / 8:.2f} ‚ÇΩ</b>
        """).strip()

        # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–ù–∞–∑–∞–¥"
        keyboard = InlineKeyboardMarkup(
            [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")]]
        )

        await callback.message.edit_text(text, reply_markup=keyboard)
        await callback.answer()

    elif data.startswith("view_active_order_"):
        order_id = data.replace("view_active_order_", "")
        active_orders = load_active_orders()
        order = next((o for o in active_orders if str(o.get("id")) == order_id), None)

        if not order:
            await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        items_text =  "\n".join(
            [f"‚Ä¢ {item['name']} x{item['qty']} ‚Äî {item.get('source_price') * item['qty']}‚ÇΩ"
             for item in order.get("items", [])]
        ).strip()

        phone = order.get("phone") or "‚Äî"
        address = order.get("address") or "–°–∞–º–æ–≤—ã–≤–æ–∑"
        time_str = order.get("time") or "–ü–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏"
        delivery_cost = order.get("delivery_price", 0) or 0
        total = order.get("total", 0) or 0

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ –û–î–ù–û–ì–û –õ–ò–®–ù–ï–ì–û –ü–†–û–ë–ï–õ–ê
        lines = [
            f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <code>{phone}</code>",
            f"üè† <b>–ê–¥—Ä–µ—Å:</b> {address}",
            f"‚è∞ <b>–í—Ä–µ–º—è:</b> {time_str}",
            f"üìÖ <b>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</b> <b>–°–µ–≥–æ–¥–Ω—è</b>",
            "",
            f"üìã <b>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</b>"
        ]

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –ë–ï–ó –æ—Ç—Å—Ç—É–ø–æ–≤
        for line in items_text.split('\n'):
            lines.append(line.strip())

        lines.extend([
            "",
            f"üöö <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> {delivery_cost}‚ÇΩ",
            f"üí∞ <b>–ò—Ç–æ–≥–æ:</b> <b>{total}‚ÇΩ</b>"
        ])

        text = "\n".join(lines)

        # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ
        keyboard = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"edit_order_{order_id}"),
                InlineKeyboardButton("‚úÖ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤", callback_data=f"order_ready_{order_id}")
            ],
            [
                InlineKeyboardButton("üñ®Ô∏è –ü–µ—á–∞—Ç—å —á–µ–∫–∞", callback_data=f"print_order_{order_id}")
            ],
            [
                InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data="admin_active_orders")
            ]
        ])

        await callback.message.edit_text(text.strip(), reply_markup=keyboard)
        await callback.answer()

    elif data.startswith("order_ready_"):
        order_id = data.replace("order_ready_", "")
        active_orders = load_active_orders()
        order = next((o for o in active_orders if str(o.get("id")) == order_id), None)

        if not order:
            await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        phone = order.get("phone") or "‚Äî"
        address = order.get("address") or "–°–∞–º–æ–≤—ã–≤–æ–∑"
        total = order.get("total", 0) or 0

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Ç–æ–ø–∏–∫ "–î–æ—Å—Ç–∞–≤–∫–∞" –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∞
        if address != "–°–∞–º–æ–≤—ã–≤–æ–∑":
            delivery_message = (
                f"üì¶ <b>–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ</b>\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <code>{phone}</code>\n"
                f"üè† <b>–ê–¥—Ä–µ—Å:</b> {address}\n"
                f"üí∞ <b>–°—É–º–º–∞:</b> <b>{total} ‚ÇΩ</b>\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"‚úÖ –ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ –∫—É—Ä—å–µ—Ä—É"
            )
            try:
                # –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫—É "–î–æ—Å—Ç–∞–≤–ª–µ–Ω"
                keyboard = InlineKeyboardMarkup([
                    [InlineKeyboardButton("üöö –î–æ—Å—Ç–∞–≤–ª–µ–Ω", callback_data=f"order_delivered_{order_id}")]
                ])

                sent_message = await bot_app.send_message(
                    chat_id=WORK_GROUP,
                    text=delivery_message,
                    reply_to_message_id=THREAD_DELIVERY_ID,
                    reply_markup=keyboard
                )

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è
                order["delivery_message_id"] = sent_message.id
                save_active_orders(active_orders)

                await callback.answer("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ ¬´–î–æ—Å—Ç–∞–≤–∫–∞¬ª.", show_alert=True)
            except Exception as e:
                logging.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–æ–ø–∏–∫ –¥–æ—Å—Ç–∞–≤–∫–∏: {e}")
                await callback.answer("‚úÖ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –¥–æ—Å—Ç–∞–≤–∫—É.", show_alert=True)
        else:
            # –°–∞–º–æ–≤—ã–≤–æ–∑ ‚Äî —Å—Ä–∞–∑—É —Å—á–∏—Ç–∞–µ–º –∑–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º
            delivery_message = (
                f"üõçÔ∏è <b>–ó–∞–∫–∞–∑ –Ω–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑ –≥–æ—Ç–æ–≤</b>\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <code>{phone}</code>\n"
                f"üí∞ <b>–°—É–º–º–∞:</b> <b>{total} ‚ÇΩ</b>\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"‚úÖ –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –∑–∞–±—Ä–∞—Ç—å"
            )
            try:
                # –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫—É "–í—ã–¥–∞–Ω"
                keyboard = InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚úÖ –í—ã–¥–∞–Ω", callback_data=f"order_delivered_{order_id}")]
                ])

                sent_message = await bot_app.send_message(
                    chat_id=WORK_GROUP,
                    text=delivery_message,
                    reply_to_message_id=THREAD_DELIVERY_ID,
                    reply_markup=keyboard
                )

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è
                order["delivery_message_id"] = sent_message.id
                save_active_orders(active_orders)

                await callback.answer("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ ¬´–î–æ—Å—Ç–∞–≤–∫–∞¬ª.", show_alert=True)
            except Exception as e:
                logging.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–æ–ø–∏–∫ –¥–æ—Å—Ç–∞–≤–∫–∏: {e}")
                await callback.answer("‚úÖ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.", show_alert=True)

    elif data.startswith("order_delivered_"):
        order_id = data.replace("order_delivered_", "")
        active_orders = load_active_orders()
        order = next((o for o in active_orders if str(o.get("id")) == order_id), None)

        if not order:
            await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ç–æ–ø–∏–∫–∞ "–î–æ—Å—Ç–∞–≤–∫–∞"
        delivery_msg_id = order.get("delivery_message_id")
        if delivery_msg_id:
            try:
                await bot_app.delete_messages(chat_id=WORK_GROUP, message_ids=delivery_msg_id)
                logging.info(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ: {delivery_msg_id}")
            except Exception as e:
                logging.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

        # –ü–µ—Ä–µ–Ω–æ—Å–∏–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        orders = load_orders()
        user_id = str(order.get("user_id", "unknown"))
        if user_id not in orders:
            orders[user_id] = []
        orders[user_id].append(order)
        save_orders(orders)
        logging.info(f"‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{order_id} –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é")

        # –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        if order in active_orders:
            active_orders.remove(order)
            save_active_orders(active_orders)  # ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            logging.info(f"‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{order_id} —É–¥–∞–ª—ë–Ω –∏–∑ active_orders.json")

        await callback.answer("‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω/–≤—ã–¥–∞–Ω –∏ —É–¥–∞–ª—ë–Ω.", show_alert=True)

    elif data.startswith("view_future_order_"):
        order_id = data.replace("view_future_order_", "")
        future_orders = load_future_orders()
        order = next((o for o in future_orders if str(o.get("id")) == order_id), None)

        if not order:
            await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        items_text = "\n".join(
            [f"‚Ä¢ {item['name']} x{item['qty']} ‚Äî {item.get('source_price') * item['qty']}‚ÇΩ"
             for item in order.get("items", [])]
        )

        phone = order.get("phone") or "‚Äî"
        address = order.get("address") or "‚Äî"
        time_str = order.get("time") or "–ü–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏"
        delivery_cost = order.get("delivery_price", 0)
        total = order.get("total", 0)
        delivery_date = order.get("delivery_date", "‚Äî")

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ –û–î–ù–û–ì–û –õ–ò–®–ù–ï–ì–û –ü–†–û–ë–ï–õ–ê
        lines = [
            f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <phone>{phone}</phone>",
            f"üè† <b>–ê–¥—Ä–µ—Å:</b> {address}",
            f"‚è∞ <b>–í—Ä–µ–º—è:</b> {time_str}",
            f"üìÖ <b>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</b> <b>{delivery_date}</b>",
            "",
            f"üìã <b>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</b>"
        ]

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –ë–ï–ó –æ—Ç—Å—Ç—É–ø–æ–≤
        for line in items_text.split('\n'):
            lines.append(line.strip())

        lines.extend([
            "",
            f"üöö <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> {delivery_cost}‚ÇΩ",
            f"üí∞ <b>–ò—Ç–æ–≥–æ:</b> <b>{total}‚ÇΩ</b>"
        ])

        text = "\n".join(lines)

        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üñ®Ô∏è –ü–µ—á–∞—Ç—å —á–µ–∫–∞", callback_data=f"print_order_{order_id}")],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data="admin_active_orders")]
        ])


        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üñ®Ô∏è –ü–µ—á–∞—Ç—å —á–µ–∫–∞", callback_data=f"print_order_{order_id}")],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data="admin_future_orders")]
        ])

        await callback.message.edit_text(text.strip(), reply_markup=keyboard)
        await callback.answer()

    elif data == "back_to_menu":
        keyboard = InlineKeyboardMarkup(
            [
                [InlineKeyboardButton("üì¶ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã", callback_data="admin_active_orders"),
                 InlineKeyboardButton("üìÖ –ó–∞–∫–∞–∑—ã –≤ –±—É–¥—É—â–µ–º", callback_data="admin_future_orders")],
                [InlineKeyboardButton("üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞", callback_data="admin_salary")]
            ]
        )
        await callback.message.edit_text("üë®‚Äçüíº <b>–ê–¥–º–∏–Ω-–º–µ–Ω—é</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=keyboard)
        await callback.answer()

    elif data.startswith("select_zone_"):
        idx = int(data.replace("select_zone_", ""))
        matches = USER_EDIT_STATE.get(user_id, {}).get("delivery_matches", [])
        if 0 <= idx < len(matches):
            zone, price, street_db = matches[idx]
            USER_EDIT_STATE[user_id]["delivery_zone"] = zone
            USER_EDIT_STATE[user_id]["delivery_price"] = price
            first_name = callback.from_user.first_name

            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –∑–æ–Ω—ã
            zone_msg_id = USER_EDIT_STATE[user_id].get("zone_selection_message_id")
            if zone_msg_id:
                try:
                    await bot_app.edit_message_text(
                        chat_id=WORK_GROUP,
                        message_id=zone_msg_id,
                        text=f"‚úÖ –í—ã–±—Ä–∞–Ω–æ: {zone}"
                    )
                except Exception as e:
                    logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: {e}")

            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–∫–∞–∑–æ–º
            await show_editable_order_inline(callback, first_name)
            await callback.answer(f"–ó–æ–Ω–∞ –≤—ã–±—Ä–∞–Ω–∞: {zone}")
        else:
            await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.")

    elif data == "edit_order_new":
        state = USER_EDIT_STATE.get(user_id)
        if not state:
            await callback.answer("‚ùå –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞")
            return

        # –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        state["awaiting_edit_order"] = True

        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üö´ –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_edit")]
        ])

        try:
            await callback.message.edit_text(
                "‚úèÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:\n\n"
                "- –î–æ–±–∞–≤—å—Ç–µ/—É–¥–∞–ª–∏—Ç–µ –±–ª—é–¥–∞\n"
                "- –û–±–Ω–æ–≤–∏—Ç–µ –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, –≤—Ä–µ–º—è",
                reply_markup=keyboard
            )
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")

        await callback.answer()

    elif data.startswith("edit_order_"):
        order_id = data.replace("edit_order_", "")
        active_orders = load_active_orders()
        order = next((o for o in active_orders if str(o.get("id")) == str(order_id)), None)

        if not order:
            await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üö´ –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data=f"cancel_edit_{order_id}")]
        ])
        await callback.message.edit_text(
            f"‚úèÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ <b>#{order_id}</b>:\n\n"
            "- –î–æ–±–∞–≤—å—Ç–µ/—É–¥–∞–ª–∏—Ç–µ –±–ª—é–¥–∞\n"
            "- –û–±–Ω–æ–≤–∏—Ç–µ –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, –≤—Ä–µ–º—è\n"
            "- –ú–æ–∂–Ω–æ –≤—Å—ë –≤–º–µ—Å—Ç–µ",
            reply_markup=keyboard
        )
        await callback.answer()

    elif data.startswith("edit_order_"):
        order_id = data.replace("edit_order_", "")
        active_orders = load_active_orders()
        order = next((o for o in active_orders if str(o.get("id")) == str(order_id)), None)

        if not order:
            await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üö´ –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data=f"cancel_edit_{order_id}")]
        ])
        await callback.message.edit_text(
            f"‚úèÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ <b>#{order_id}</b>:\n\n"
            "- –î–æ–±–∞–≤—å—Ç–µ/—É–¥–∞–ª–∏—Ç–µ –±–ª—é–¥–∞\n"
            "- –û–±–Ω–æ–≤–∏—Ç–µ –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, –≤—Ä–µ–º—è\n"
            "- –ú–æ–∂–Ω–æ –≤—Å—ë –≤–º–µ—Å—Ç–µ",
            reply_markup=keyboard
        )
        await callback.answer()

    elif data == "confirm_order":
        state = USER_EDIT_STATE.get(user_id)
        if not state:
            await callback.answer("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        first_name = callback.from_user.first_name
        total = calculate_total(state["items"], delivery_price=state.get("delivery_price", 0))

        # === –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏ ===
        delivery_date_str = state.get("delivery_date")
        today_str = datetime.now().strftime("%d.%m.%Y")

        is_today = delivery_date_str == today_str or not delivery_date_str

        # === –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞ ===
        order_obj = {
            "user_id": user_id,
            "client_name": first_name,
            "phone": state["phone"],
            "address": state["address"],
            "time": state["time"],
            "delivery_date": delivery_date_str or today_str,
            "delivery_zone": state["delivery_zone"],
            "delivery_price": state.get("delivery_price", 0),
            "items": state["items"],
            "total": total,
            "timestamp": datetime.now(timezone.utc).isoformat()
        }

        # === –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω—É–∂–Ω—É—é –±–∞–∑—É ===
        if is_today:
            add_active_order(order_obj)
            logging.info(f"‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {order_obj['phone']}")
        else:
            add_future_order(order_obj)
            logging.info(f"üìÖ –ë—É–¥—É—â–∏–π –∑–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {order_obj['delivery_date']} | {order_obj['phone']}")
        # === –ü–µ—á–∞—Ç—å —á–µ–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è ===
        if is_today:
            try:
                print_receipt_html(state)
                await callback.message.reply("üñ®Ô∏è –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å!")
            except Exception as e:
                logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏: {e}")

        # === –£–¥–∞–ª—è–µ–º –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è ===
        del USER_EDIT_STATE[user_id]

        # === –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
        orders = load_orders()
        user_orders = orders.get(str(user_id), [])
        user_orders.append(order_obj)
        orders[str(user_id)] = user_orders
        save_orders(orders)

    elif data.startswith("cancel_edit_"):
        order_id = data.replace("cancel_edit_", "")
        active_orders = load_active_orders()
        order = next((o for o in active_orders if str(o.get("id")) == str(order_id)), None)

        if not order:
            await callback.message.edit_text(
                "‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_active_orders")]
                ])
            )
            await callback.answer()
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞
        items_text = "\n".join(
            [f"‚Ä¢ {item['name']} x{item['qty']} ‚Äî {item.get('source_price', 0) * item['qty']}‚ÇΩ"
             for item in order.get("items", [])]
        )
        phone = order.get("phone") or "‚Äî"
        address = order.get("address") or "‚Äî"
        time_str = order.get("time") or "–ü–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏"
        delivery_cost = order.get("delivery_price", 0)
        total = order.get("total", 0)

        lines = [
            f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <code>{phone}</code>",
            f"üè† <b>–ê–¥—Ä–µ—Å:</b> {address}",
            f"‚è∞ <b>–í—Ä–µ–º—è:</b> {time_str}",
            f"üìÖ <b>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</b> <b>–°–µ–≥–æ–¥–Ω—è</b>",
            "",
            f"üìã <b>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</b>"
        ]

        for line in items_text.split('\n'):
            lines.append(line.strip())

        lines.extend([
            "",
            f"üöö <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> {delivery_cost}‚ÇΩ",
            f"üí∞ <b>–ò—Ç–æ–≥–æ:</b> <b>{total}‚ÇΩ</b>"
        ])

        text = "\n".join(lines)

        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑", callback_data=f"edit_order_{order_id}")],
            [InlineKeyboardButton("üñ®Ô∏è –ü–µ—á–∞—Ç—å —á–µ–∫–∞", callback_data=f"print_order_{order_id}")],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data="admin_active_orders")]
        ])

        await callback.message.edit_text(text, reply_markup=keyboard)
        await callback.answer()

    elif data == "add_item":
        user_id = callback.from_user.id
        if user_id not in USER_EDIT_STATE:
            initialize_user_state(user_id)

        # ‚úÖ –û—á–∏—â–∞–µ–º temp_cart –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        USER_EDIT_STATE[user_id]["temp_cart"] = []

        await show_categories(callback)
        await callback.answer()

    elif data == "remove_item":
        user_id = callback.from_user.id
        if user_id not in USER_EDIT_STATE:
            initialize_user_state(user_id)
        state = USER_EDIT_STATE[user_id]

        if not state.get("items"):
            await callback.answer("–í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç –±–ª—é–¥.")
            return

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
        keyboard = []
        for item in state["items"]:
            label = f"{item['name']} (x{item['qty']})"
            keyboard.append([InlineKeyboardButton(label, callback_data=f"remove_{item['name']}")])
        keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_order")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        try:
            await callback.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=reply_markup)
            await callback.answer()
        except Exception as e:
            logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è: {e}")
            await callback.answer("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é —É–¥–∞–ª–µ–Ω–∏—è")

    elif data.startswith("remove_"):
        user_id = callback.from_user.id
        item_name = data.replace("remove_", "")
        state = USER_EDIT_STATE.get(user_id)
        if not state:
            await callback.answer("‚ùå –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞")
            return

        items = state["items"]
        item = next((it for it in items if it["name"] == item_name), None)
        if not item:
            await callback.answer("–ü–æ–∑–∏—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return

        if item["qty"] > 1:
            item["qty"] -= 1
            await callback.answer(f"‚ûñ –£–º–µ–Ω—å—à–µ–Ω–æ: {item_name} (–æ—Å—Ç–∞–ª–æ—Å—å x{item['qty']})")
        else:
            items.remove(item)
            await callback.answer(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ: {item_name}")

        # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–∫–∞–∑–æ–º
        first_name = callback.from_user.first_name
        await update_order_message(user_id, first_name)

        # ‚¨áÔ∏è –í–ê–ñ–ù–û: –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏ –º–µ–Ω—é —É–¥–∞–ª–µ–Ω–∏—è!
        if items:  # –µ—Å–ª–∏ –µ—â—ë –µ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏
            keyboard = []
            for it in items:
                label = f"{it['name']} (x{it['qty']})"
                keyboard.append([InlineKeyboardButton(label, callback_data=f"remove_{it['name']}")])
            keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_order")])
            reply_markup = InlineKeyboardMarkup(keyboard)

            try:
                await callback.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=reply_markup)
            except Exception as e:
                if "message is not modified" not in str(e).lower():
                    logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–µ–Ω—é —É–¥–∞–ª–µ–Ω–∏—è: {e}")
        else:
            # –ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∑–∞–∫–∞–∑—É
            try:
                await callback.message.edit_text("‚úÖ –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã.", reply_markup=None)
                await asyncio.sleep(1)
                await update_order_message(user_id, first_name)
            except Exception as e:
                logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —É–¥–∞–ª–µ–Ω–∏—è: {e}")


    elif data.startswith("print_order_"):
        order_id = int(data.replace("print_order_", ""))

        # –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö
        active_orders = load_active_orders()
        order = next((o for o in active_orders if o["id"] == order_id), None)

        if not order:
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∏—â–µ–º –≤ –±—É–¥—É—â–∏—Ö
            future_orders = load_future_orders()
            order = next((o for o in future_orders if o["id"] == order_id), None)

        if not order:
            await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º state_for_print –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
        state_for_print = {
            "items": order["items"],
            "phone": order.get("phone", ""),
            "address": order.get("address", ""),
            "time": order.get("time", ""),
            "delivery_date": order.get("delivery_date", ""),
            "delivery_zone": order.get("delivery_zone", ""),
            "delivery_price": order.get("delivery_price", 0),
            # –≠—Ç–∏ –ø–æ–ª—è –Ω—É–∂–Ω—ã, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—á–∞—Ç–∏
            "temp_cart": [],
            "awaiting_edit_order": False
        }

        try:
            print_receipt_html(state_for_print)
            await callback.answer("üñ®Ô∏è –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å!")
            logging.info(f"üñ®Ô∏è –ß–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω: –∑–∞–∫–∞–∑ ‚Ññ{order_id}")
        except Exception as e:
            await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏.")
            logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ —á–µ–∫–∞ (–ø–æ ID): {e}")

    elif data == "back_to_order":
        user_id = callback.from_user.id
        first_name = callback.from_user.first_name
        await update_order_message(user_id, first_name)
        await callback.answer()

    elif data.startswith("cat_"):
        category = data.replace("cat_", "")
        USER_EDIT_STATE[user_id]["last_category"] = category
        await show_dishes_by_category(user_id, category)
        await callback.answer()

    elif data.startswith("add_"):
        try:
            item_id = int(data.replace("add_", ""))
        except ValueError:
            await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID –±–ª—é–¥–∞")
            return

        item = next((it for it in MENU_ITEMS if it["id"] == item_id), None)
        if not item:
            await callback.answer("‚ùå –ë–ª—é–¥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
            return

        user_id = callback.from_user.id
        if user_id not in USER_EDIT_STATE:
            initialize_user_state(user_id)

        temp_cart = USER_EDIT_STATE[user_id]["temp_cart"]
        existing = next((it for it in temp_cart if it["name"] == item["name"]), None)
        if existing:
            existing["qty"] += 1
        else:
            # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º source_price –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞
            temp_cart.append({
                "name": item["name"],
                "qty": 1,
                "comment": "",
                "source_price": item["price"]  # ‚Üê –ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ!
            })

        category = USER_EDIT_STATE[user_id].get("last_category")
        if not category:
            return

        await show_dishes_by_category(user_id, category)


    elif data == "back_to_categories":
        await show_categories(callback)
        await callback.answer()

    elif data == "finish_edit":
        user_id = callback.from_user.id
        state = USER_EDIT_STATE.get(user_id)
        if not state:
            return

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å—ë –∏–∑ temp_cart –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–∫–∞–∑
        temp_cart = state.get("temp_cart", [])
        cart = state.setdefault("items", [])

        for new_item in temp_cart:
            existing = next((it for it in cart if it["name"] == new_item["name"]), None)
            if existing:
                existing["qty"] += new_item["qty"]
            else:
                # ‚úÖ –ö–æ–ø–∏—Ä—É–µ–º source_price
                cart.append(new_item.copy())  # ‚Üê .copy() —Å–æ—Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ –ø–æ–ª—è

        # –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä
        state["temp_cart"] = []

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        first_name = callback.from_user.first_name
        await update_order_message(user_id, first_name)
        await callback.answer("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã")

    elif data == "edit_zone":
        await show_delivery_zones(callback.message)
        await callback.answer()

    elif data.startswith("zone_"):
        zone = data.replace("zone_", "")
        USER_EDIT_STATE[user_id]["delivery_zone"] = zone
        await update_order_message(user_id, callback.from_user.first_name)
        await callback.answer(f"–†–∞–π–æ–Ω –≤—ã–±—Ä–∞–Ω: {zone.capitalize()}")

    elif data.startswith("print_future_"):
        target_user_id = int(data.replace("print_future_", ""))

        # –ò—â–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –±—É–¥—É—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
        future_orders = load_future_orders()
        order = next((ord for ord in future_orders if ord["user_id"] == target_user_id), None)

        if not order:
            await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –±—É–¥—É—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤.")
            logging.warning(f"‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ: user_id={target_user_id}")
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º state –¥–ª—è –ø–µ—á–∞—Ç–∏
        state_for_print = {
            "items": order["items"],
            "phone": order["phone"],
            "address": order["address"],
            "time": order["time"],
            "delivery_date": order["delivery_date"],
            "delivery_zone": order["delivery_zone"],
            "delivery_price": order["delivery_price"],
            "temp_cart": [],
            "awaiting_edit_order": False
        }

        try:
            print_receipt_html(state_for_print)
            await callback.answer("üñ®Ô∏è –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å!")
            logging.info(f"üñ®Ô∏è –ß–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω –ø–æ –∫–Ω–æ–ø–∫–µ (–∏–∑ –±–∞–∑—ã): user_id={target_user_id}, –∑–∞–∫–∞–∑ ‚Ññ{len(load_orders()) + 1}")
        except Exception as e:
            await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏.")
            logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ –ø–æ –∫–Ω–æ–ø–∫–µ: {e}")

    elif data == "print_receipt":
        state = USER_EDIT_STATE.get(user_id)
        if not state:
            await callback.answer("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏.")
            return

        total = calculate_total(state["items"], delivery_price=state.get("delivery_price", 0))

        receipt_lines = []
        receipt_lines.append("   –ú–∞–≥–∞–∑–∏–Ω \"–û—Ä—Ö–∏–¥–µ—è\"")
        receipt_lines.append("-" * 22)
        receipt_lines.append(f"–ó–∞–∫–∞–∑ ‚Ññ{len(load_orders()) + 1:06d}")
        now = datetime.now().strftime("%d.%m %H:%M")
        receipt_lines.append(f"–í—Ä–µ–º—è: {now}")
        receipt_lines.append("-" * 22)

        if state["phone"]:
            receipt_lines.append(f"–¢–µ–ª: {state['phone']}")
        if state["address"]:
            receipt_lines.append(f"–ê–¥—Ä–µ—Å: {state['address']}")
        if state["time"]:
            receipt_lines.append(f"–í—Ä–µ–º—è: {state['time']}")
        if state.get("delivery_date"):
            receipt_lines.append(f"–î–∞—Ç–∞: {state['delivery_date']}")
        if state["delivery_zone"]:
            receipt_lines.append(f"–†–∞–π–æ–Ω: {state['delivery_zone'].capitalize()}")
        receipt_lines.append(f"–î–æ—Å—Ç–∞–≤–∫–∞: {state.get('delivery_price', 0):>6} ‚ÇΩ")

        receipt_lines.append("-" * 22)

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏ —Ü–µ–Ω–æ–π –Ω–∞ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö
        for idx, item in enumerate(state["items"], start=1):
            name = item["name"]
            qty = item["qty"]
            comment = item["comment"] if item["comment"] else ""
            price_per_unit = item.get("source_price")
            if price_per_unit is None:
                menu_item = next((i for i in MENU_ITEMS if i["name"] == item["name"]), None)
                price_per_unit = menu_item["price"] if menu_item else 0
            line_total = price_per_unit * item["qty"]

            # –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
            item_line = f"{idx}. {name}"
            receipt_lines.append(item_line)

            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
            qty_line = f"   –ö–æ–ª-–≤–æ: {qty} —à—Ç."
            receipt_lines.append(qty_line)

            # –¶–µ–Ω–∞ –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
            price_line = f"   –¶–µ–Ω–∞: {line_total:,}".replace(",", " ") + " ‚ÇΩ"
            receipt_lines.append(price_line)

            # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if comment:
                receipt_lines.append(f"   ‚ö†Ô∏è{comment.capitalize()}")

            # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –ø–æ–∑–∏—Ü–∏—è–º–∏
            if idx < len(state["items"]):
                receipt_lines.append("-" * 22)

        receipt_lines.append("-" * 22)

        # –ò—Ç–æ–≥–æ
        total_str = f"{total:,}".replace(",", " ") + " ‚ÇΩ"
        receipt_lines.append(f"–ò–¢–û–ì–û:     {total_str:>8}")

        receipt_lines.append("-" * 22)
        receipt_lines.append("–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!")
        receipt_lines.append("–ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –µ—â—ë!")

        receipt_text = "\n".join(receipt_lines)

        try:
            print_receipt_html(state)
            await callback.answer("üñ®Ô∏è –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å!")
        except Exception as e:
            await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏.")
            logging.error(f"–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏: {e}")

        try:
            await bot_app.send_message(
                chat_id=WORK_GROUP,
                text=f"üñ®Ô∏è <b>–ß–µ–∫ –¥–ª—è –ø–µ—á–∞—Ç–∏ (58–º–º)</b>:\n\n<pre>{receipt_text}</pre>"
            )
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞ –≤ Telegram: {e}")